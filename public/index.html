<!DOCTYPE html>
<html lang="en">

<head>
    <title>ChatGPT</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style type="text/css">
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            min-width: 320px;
            text-align: center;
            font-family: 'Roboto', sans-serif;
            background-color: #f0f0f0;
        }

        .wrapper {
            width: 100%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 90%;
            max-width: 600px;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            position: relative;
        }

        #output {
            text-align: left;
            white-space: pre-wrap;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
        }

        form {
            display: inline-block;
            width: 100%;
        }

        input[name="input"] {
            width: 95%;
            padding: 5px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        input[type="submit"],
        button {
            width: 95%;
            padding: 5px 0;
            font-size: 14px;
            background-color: #0099ff;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
        }

        input[type="submit"]:hover,
        button:hover {
            background-color: #007acc;
        }

        select[name="systemMessage"] {
            width: 95%;
            padding: 5px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 5px;
        }

        .product-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 5px;
            background-color: #f0f0f0;
            border-radius: 10px;
            box-shadow: 10px 10px 15px #d9d9d9, -10px -10px 15px #ffffff;
            overflow: hidden;
            cursor: pointer;
            width: 200px;
            height: 200px;
        }

        .product-container img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            transition: all 0.3s;
        }

        .product-container:hover img {
            transform: scale(1.05);
        }

        .product-title {
            padding: 5px;
            font-size: 14px;
        }
    </style>
    <script>
        let messageHistory = [
            {
                "role": "system",
                "content": "You are a helpful assistant that provides detailed and accurate information."
            }
        ];


        async function searchProductsByTags(theme, style, color = "") {
            let combinedTags = `tag:'${theme}' AND tag:'${style}'`;
            if (color) {
                combinedTags += ` AND tag:'${color}'`;
            }
            const query = `
    {
        products(first: 5, query: "${combinedTags} AND status:active") {
            edges {
                node {
                    id
                    title
                    handle
                    featuredImage {
                        transformedSrc(maxWidth: 100, maxHeight: 100, crop: CENTER)
                    }
                }
            }
        }
    }`;


            try {
                const response = await fetch('/shopify-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });

                const jsonResponse = await response.json();
                if (jsonResponse.data && jsonResponse.data.products) {
                    return jsonResponse.data.products.edges.slice(0, 5).map(edge => {
                        return {
                            id: edge.node.id,
                            title: edge.node.title,
                            handle: edge.node.handle,
                            imageUrl: edge.node.featuredImage.transformedSrc
                        };
                    });
                }
            } catch (error) {
                console.error("Error fetching products:", error);
            }
            return [];
        }





        const userAction = async (event) => {
            event.preventDefault();
            const input = "" + document.forms["input"]["input"].value;

            messageHistory.push({ "role": "user", "content": input });

            // Disable input field and Send button while processing request
            document.forms["input"]["input"].disabled = true;
            document.forms["input"]["submit"].disabled = true;

            const response = await fetch('/api/completions', {
                method: "POST",
                body: JSON.stringify({ messageHistory: messageHistory }),
                headers: {
                    "content-type": "application/json",
                },
            });

            const jsonResponse = await response.json();
            console.log(jsonResponse);
            const aiReply = jsonResponse.choices[0].message.content;
            console.log(messageHistory);
            let message = "";
            let tags = [];

            if (aiReply.includes("TAGSTOSEARCH:")) {
                const [messagePart, tagsPart] = aiReply.split("TAGSTOSEARCH:");
                message = messagePart.trim();
                tags = tagsPart.trim().split(",");
            } else {
                message = aiReply.trim();
            }

            if (tags.length > 0) {
                const [theme, style, color] = tags;
                searchProductsByTags(theme, style, color).then(product_links => {
                    const displayMessage = message;

                    const AnswerLog = messageHistory.map((msg, index) => {
                        if (msg.role === "system") return "";
                        return `<br><br>${msg.role === 'user' ? 'ME' : 'AI'}: ${msg.content}`;
                    });

                    if (product_links.length > 0) {
                        const product_links_html = product_links.slice(0, 5).map(link => `
            <a href="https://taylorjoelle.com/products/${link.handle}" target="_blank" style="text-decoration: none; color: inherit;">
                <div class="product-container">
                    <img src="${link.imageUrl}" alt="${link.title}">
                    <div class="product-title">${link.title}</div>
                </div>
            </a>
            `).join("");
                        message += "<br><br>" + product_links_html;
                    }
                    messageHistory.push({ "role": "assistant", "content": displayMessage });

                    document.forms["input"]["input"].value = "";
                    document.getElementById("output").innerHTML = AnswerLog.join("") + `<br><br>AI: ${message}`;

                    // Re-enable input field and Send button after processing request
                    document.forms["input"]["input"].disabled = false;
                    document.forms["input"]["submit"].disabled = false;
                }).catch((error) => {
                    console.error("Error displaying product links:", error);
                });
            } else {
                messageHistory.push({ "role": "assistant", "content": aiReply });

                const AnswerLog = messageHistory.map((msg, index) => {
                    if (msg.role === "system") return "";
                    return `<br><br>${msg.role === 'user' ? 'ME' : 'AI'}: ${msg.content}`;
                });

                // Re-enable input field and Send button after processing request
                document.forms["input"]["input"].disabled = false;
                document.forms["input"]["submit"].disabled = false;
            }
        };




        const clearHistory = () => {
            const newSystemMessage = document.forms["systemMessageForm"]["systemMessage"].value;
            messageHistory = [
                {
                    "role": "system",
                    "content": newSystemMessage
                }
            ];
            document.getElementById("output").innerHTML = "";
        }

        const addCustomOption = () => {
            const customOption = document.forms["addOptionForm"]["customOption"].value;
            if (customOption === "") return; // Don't add an empty option

            const selectElement = document.forms["systemMessageForm"]["systemMessage"];
            const newOption = document.createElement("option");
            newOption.value = customOption;
            newOption.text = customOption;
            selectElement.add(newOption);

            document.forms["addOptionForm"]["customOption"].value = ""; // Clear the input field
        }
    </script>
</head>

<body>
    <div class="wrapper">
        <div class="container">
            <p id="output" style="white-space: pre-wrap;"></p>
            <form id="input" onsubmit="userAction(event)">
                <input name="input" autofocus placeholder="User input" style="width: 95%;"><br>
                <input type="submit" name="submit" value="Send" style="margin-top: 5px;">
            </form>
            <button onclick="clearHistory()" style="margin-top: 5px;">Clear History</button>
            <form id="systemMessageForm" style="margin-top: 5px;">
                <select name="systemMessage" style="width: 95%;">
                    <option value="You are an AI shopping assistant working for a company named Taylor Joelle Designs, which specializes in childrens dresses but also sells t-shirts, skirts, and swimsuits. You will helping customers find items they are interested in. Avoid mentioning the same thing in multiple tags. Your response will have two parts: a message to the customer and a list of tags for searching. The customer won't see the tags, so don't discuss them in the message. Follow the given format, using no more than three tags without spaces or punctuation, although if the customer does not ask for a color do not include it in the tags. The tags should include a theme (e.g., dress or swimsuit) which should default to dress, a style (e.g., princess or animal) (SHOULD NEVER BE A COLOR OR THE WORD COLOR), and a color which should only be one word only and only one color at a time (e.g., pink or blue). DO NOT INCLUDE A COLOR IF IT IS NOT ASKED FOR BY THE CUSTOMER, ONLY INCLUDE THE FIRST TWO TAGS IF THERE IS NO COLOR. Don't require customers to answer follow up questions always decide on tags even if you dont have all the information about what the customer wants. Don't ever repeat the format twice in one response that ruins your purpose and you will be punished. Do not include any notes ever. Example format:
                    MESSAGETOCUSTOMER:
                    Your message to the customer.
                    TAGSTOSEARCH:
                    theme,style,color">Shopping assistant</option>
                </select>
            </form>
            <form id="addOptionForm" style="margin-top: 5px;">
                <input name="customOption" placeholder="Add custom option" style="width: 95%;">
                <button type="button" onclick="addCustomOption()" style="margin-top: 5px;">Add Option</button>
            </form>
        </div>
    </div>
</body>

</html>