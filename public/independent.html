<!DOCTYPE html>
<html lang="en">

<head>
    <title>ChatGPT</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style type="text/css">
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            min-width: 320px;
            text-align: center;
            font-family: 'Roboto', sans-serif;
            background-color: #f0f0f0;
        }

        .wrapper {
            width: 100%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 90%;
            max-width: 600px;
            padding: 30px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            position: relative;
        }

        #output {
            text-align: left;
            white-space: pre-wrap;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
        }

        form {
            display: inline-block;
            width: 100%;
        }

        input[name="input"] {
            width: 95%;
            padding: 5px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        input[type="submit"],
        button {
            width: 95%;
            padding: 5px 0;
            font-size: 14px;
            background-color: #0099ff;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
        }

        input[type="submit"]:hover,
        button:hover {
            background-color: #007acc;
        }

        select[name="systemMessage"] {
            width: 95%;
            padding: 5px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 5px;
        }

        .product-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 5px;
            background-color: #f0f0f0;
            border-radius: 10px;
            box-shadow: 10px 10px 15px #d9d9d9, -10px -10px 15px #ffffff;
            overflow: hidden;
            cursor: pointer;
            width: 200px;
            height: 200px;
        }

        .product-container img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            transition: all 0.3s;
        }

        .product-container:hover img {
            transform: scale(1.05);
        }

        .product-title {
            padding: 5px;
            font-size: 14px;
        }
    </style>
    <script>
        let messageHistory = [
            {
                "role": "system",
                "content": "You are a helpful assistant that provides detailed and accurate information."
            }
        ];

        async function fetchProducts() {
            const query = `
    {
      products(first: 250, query: "status:active") {
        edges {
          node {
            title
            tags
          }
        }
      }
    }
  `;

            try {
                const response = await fetch('/shopify-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });

                const jsonResponse = await response.json();
                if (jsonResponse.data && jsonResponse.data.products) {

                    return jsonResponse.data.products.edges.map(edge => {
                        const relevantTags = edge.node.tags.filter(tag => {
                            return !/^cf-size-/.test(tag) && !/^all/.test(tag) && !/^3053/.test(tag) && !/^dress/.test(tag) && !/^classic/.test(tag) && !/^childrens/.test(tag);
                        }).slice(0, 5);
                        const top3Tags = edge.node.tags.slice(0, 3);

                        return {
                            title: edge.node.title,
                            tags: relevantTags,
                        };
                    });
                }
            } catch (error) {
                console.error("Error fetching products:", error);
            }
            return [];
        }

        async function searchProductsByTitles(titles) {
            const titleQueries = titles.map(title => `title:'${title.trim()}'`).join(" OR ");
            const query = `
    {
        products(first: 5, query: "${titleQueries} AND status:active") {
            edges {
                node {
                    id
                    title
                    handle
                    featuredImage {
                        transformedSrc(maxWidth: 100, maxHeight: 100, crop: CENTER)
                    }
                }
            }
        }
    }`;

            try {
                const response = await fetch('/shopify-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "titles": titles
                    })

                });

                const jsonResponse = await response.json();
                if (jsonResponse.data && jsonResponse.data.products) {
                    return jsonResponse.data.products.edges.slice(0, 5).map(edge => {
                        return {
                            id: edge.node.id,
                            title: edge.node.title,
                            handle: edge.node.handle,
                            imageUrl: edge.node.featuredImage.transformedSrc
                        };
                    });
                }
            } catch (error) {
                console.error("Error fetching products:", error);
            }
            return [];
        }





        const userAction = async (event) => {
            event.preventDefault();
            const input = "" + document.forms["input"]["input"].value;

            messageHistory.push({ "role": "user", "content": input });

            // Disable input field and Send button while processing request
            document.forms["input"]["input"].disabled = true;
            document.forms["input"]["submit"].disabled = true;

            const response = await fetch('/api/completions', {
                method: "POST",
                body: JSON.stringify({ messageHistory: messageHistory }),
                headers: {
                    "content-type": "application/json",
                },
            });

            const jsonResponse = await response.json();
            console.log(jsonResponse);
            const aiReply = jsonResponse.choices[0].message.content;
            console.log(messageHistory);
            let message = "";
            let titles = [];

            if (aiReply.includes("TITLES:")) {
                const [messagePart, titlesPart] = aiReply.split("TITLES:");
                message = messagePart.trim();
                titles = titlesPart.trim().split(",");
            } else {
                message = aiReply.trim();
            }

            if (titles.length > 0) {
                const sanitizedTitles = titles.map(title => title.trim());
                searchProductsByTitles(sanitizedTitles).then(product_links => {
                    const displayMessage = message;

                    const AnswerLog = messageHistory.map((msg, index) => {
                        if (msg.role === "system") return "";
                        return `<br><br>${msg.role === 'user' ? 'ME' : 'AI'}: ${msg.content}`;
                    });

                    if (product_links.length > 0) {
                        const product_links_html = product_links.slice(0, 5).map(link => `
            <a href="https://taylorjoelle.com/products/${link.handle}" target="_blank" style="text-decoration: none; color: inherit;">
                <div class="product-container">
                    <img src="${link.imageUrl}" alt="${link.title}">
                    <div class="product-title">${link.title}</div>
                </div>
            </a>
            `).join("");
                        message += "<br><br>" + product_links_html;
                    }
                    messageHistory.push({ "role": "assistant", "content": displayMessage });

                    document.forms["input"]["input"].value = "";
                    document.getElementById("output").innerHTML = AnswerLog.join("") + `<br><br>AI: ${message}`;

                    // Re-enable input field and Send button after processing request
                    document.forms["input"]["input"].disabled = false;
                    document.forms["input"]["submit"].disabled = false;
                }).catch((error) => {
                    console.error("Error displaying product links:", error);
                });
            } else {
                const AnswerLog = messageHistory.map((msg, index) => {
                    if (msg.role === "system") return "";
                    return `<br><br>${msg.role === 'user' ? 'ME' : 'AI'}: ${msg.content}`;
                });

                document.getElementById("output").innerHTML = AnswerLog.join("") + `<br><br>AI: ${message}`;

                // Re-enable input field and Send button after processing request
                document.forms["input"]["input"].disabled = false;
                document.forms["input"]["submit"].disabled = false;
            }
        };




        const clearHistory = async () => {
            const newSystemMessage = document.forms["systemMessageForm"]["systemMessage"].value;

            // Fetch products
            const products = await fetchProducts();
            console.log(products);
            // Create a string with product titles and tags
            const productInfoString = products.map(product => `${product.title}: ${product.tags.join(', ')}`).join('\n');

            // Add products to the system message
            messageHistory = [
                {
                    "role": "system",
                    "content": newSystemMessage + `\n\nProducts:\n${productInfoString}`
                }
            ];
            document.getElementById("output").innerHTML = "";
        };

    </script>
</head>

<body>
    <div class="wrapper">
        <div class="container">
            <p id="output" style="white-space: pre-wrap;"></p>
            <form id="input" onsubmit="userAction(event)">
                <input name="input" autofocus placeholder="User input" style="width: 95%;"><br>
                <input type="submit" name="submit" value="Send" style="margin-top: 5px;">
            </form>
            <button onclick="clearHistory()" style="margin-top: 5px;">Clear History</button>
            <form id="systemMessageForm" style="margin-top: 5px;">
                <select name="systemMessage" style="width: 95%;">
                    <option value="You are an AI shopping assistant working for a company named Taylor Joelle Designs, which specializes in children's dresses but also sells t-shirts, skirts, and swimsuits. You will be helping customers find items they are interested in. Your response will have two parts: a message to the customer and a list of five product titles. The customer won't see the titles, so don't discuss them in the message. Follow the given format, and don't require customers to answer follow-up questions; always decide on product titles even if you don't have all the information about what the customer wants. Example format:
                    MESSAGETOCUSTOMER:
                    Your message to the customer.
                    TITLESFORPRODUCTS:
                    1. Product Title 1
                    2. Product Title 2
                    3. Product Title 3
                    4. Product Title 4
                    5. Product Title 5">Shopping assistant</option>
                </select>
            </form>
            <form id="addOptionForm" style="margin-top: 5px;">
                <input name="customOption" placeholder="Add custom option" style="width: 95%;">
                <button type="button" onclick="addCustomOption()" style="margin-top: 5px;">Add Option</button>
            </form>
        </div>
    </div>
</body>

</html>